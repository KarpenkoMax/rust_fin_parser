# Конвертер банковских выписок

Небольшой набор утилит и библиотек для работы с банковскими выписками в разных форматах:

- **CSV** (экспорт из интернет-банка)
- **CAMT.053** (XML, ISO 20022)
- **MT940** (SWIFT)

Все форматы приводятся к единой внутренней структуре (`Statement`, `Transaction`), после чего данные можно конвертировать между форматами или сравнивать выписки друг с другом.

---

## Структура проекта

Проект состоит из библиотеки `parser` и набора CLI-утилит, которые её используют.

- `parser/` (текущий crate)
  - `Cargo.toml` — метаданные и зависимости библиотеки
  - `src/`
    - `lib.rs` — корневой модуль, публичные реэкспорты типов и модулей
    - `model.rs` — общая доменная модель:
      - `Statement`, `Transaction`, `Currency`, `Balance`, `Direction` и т.п.
    - `error.rs` — типы ошибок парсинга (`ParseError` и др.)

    - CSV:
      - `csv_parser.rs` — публичный интерфейс для работы с CSV (`CsvData`, конвертация в общую модель)
      - `csv_parser/` — реализация CSV-парсера

    - CAMT.053:
      - `camt053.rs` — публичный интерфейс для работы с CAMT.053 (`Camt053Data`)
      - `camt053/` — реализация парсера CAMT.053

    - MT940:
      - `mt940.rs` — публичный интерфейс для работы с MT940 (`Mt940Data`)
      - `mt940/` — реализация парсера MT940

    - Сериализация:
      - `serialization.rs` — конвертация общей модели в разные форматы
      - `serialization/` — формат-специфичная сериализация

  - `tests/` — интеграционные тесты поверх публичного API:
    - `parsing_csv.rs`, `parsing_camt053.rs`, `parsing_mt940.rs` — проверка парсинга каждого формата
    - `roundtrip_csv.rs`, `roundtrip_camt053.rs`, `roundtrip_mt940.rs`, `roundtrip_all_formats.rs` — проверки «туда-обратно» между форматами
    - `fixtures/` — тестовые файлы выписок разных форматов

- CLI-утилиты (в том же workspace)
  - `cli-converter/`
    - использует библиотеку `parser` для чтения входного файла и конвертации между форматами (`csv`, `camt053`, `mt940`);
    - умеет писать результат в stdout или в файл.
  - `cli-comparer/` (если подключён)
    - использует `parser` для чтения двух выписок и сравнения их как последовательностей `Statement` / `Transaction`.


---

## Использование: `cli-converter`

Конвертирует входной файл с выпиской из одного формата в другой.

Поддерживаемые форматы для флагов `--input-format` и `--output-format`:

- `csv`
- `camt053`
- `mt940`

### Примеры

#### Конвертация CSV → CAMT.053 (XML) с выводом в файл

```bash
cargo run --bin cli-converter -- \
  --input parser/tests/fixtures/csv/example.csv \
  --input-format csv \
  --output-format camt053 \
  --to-file out.xml
```

Конвертация CAMT.053 → MT940 с выводом в stdout
```bash
cargo run --bin cli-converter -- \
  --input parser/tests/fixtures/camt053/camt053_example \
  --input-format camt053 \
  --output-format mt940
```

## Использование: `cli-comparer`

`cli-comparer` читает две выписки в любых поддерживаемых форматах (`csv`, `camt053`, `mt940`), парсит их в общую структуру `Statement` и построчно сравнивает транзакции. При отличиях печатает разницу, при полном совпадении — `statements are equal`.

Пример:

```bash
cargo run --bin cli-comparer -- \
  --file1 parser/tests/fixtures/csv/example.csv   --format1 csv \
  --file2 parser/tests/fixtures/camt053/camt053_example --format2 camt053
```

## Принятые допущения

Сделано несколько упрощающих допущений:

- **Берём только первый `Statement`**
  - Многие форматы (особенно MT940 / CAMT.053) позволяют несколько выписок в одном файле (несколько сообщений, несколько `<Stmt>` и т.п.).
  - Парсер может отдать несколько `Statement`, но:
    - CLI-утилиты сейчас используют **только первый** `Statement` из результата.
    - Остальные просто игнорируются.

- **Одна логическая выписка на файл**
  - Ожидается, что во входном файле содержится выписка по одному счёту.
  - Если банк кладёт несколько счётов в один файл, результат может быть неполным или неожиданным.

- **Одна валюта на выписку**
  - Для `Statement` детектируется одна основная валюта:
    - сначала берём валюту счёта,
    - если её нет — валюту в балансах,
    - если и там нет — валюту первой операции.
  - Считается, что все операции в рамках `Statement` в той же валюте, даже если формат формально позволяет иное.

- **Формат CSV заточен под конкретный банк**
  - CSV-парсер ориентируется на фиксированный набор колонок и их порядок.
  - Если структура CSV сильно отличается (другой экспорт, другой банк), парсер может возвращать ошибку или некорректные данные.

- **Кодировка входных файлов**
  - Предполагается, что входные файлы в кодировке **UTF-8**.
  - Другие кодировки (CP1251 и т.п.) сейчас не обрабатываются — их нужно предварительно конвертировать.

- **Потеря данных**
  - Допускается потеря или изменение по ряду полей при конвертации (в основном касается MT940)

